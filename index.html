<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width" initial-scale="1.0">

    <link rel="stylesheet" type="text/css" href="./nobels.css">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inconsolata|Tangerine|Krub|Raleway|Merriweather">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
    <link rel="stylesheet" href="./normalize.css">

</head>

<body>
    <!--table to pick categories-->
    <div class="tab">
        <table class="tg">
            <tr>
                <th class="top" colspan="3">Nobel Laureates</th>
            </tr>
            <tr>
                <td class="top" colspan="3">This page displays all nobel laureates from 1901, the year of the award's foundation, to 2018.
                </td>
            </tr>

            <tr class="tg">
                <td class="borderbox">
                    <p>Start year:
                        <input class="year" type="text" id="start" pattern="^(19|20)\d{2}" value="">
                        <br><br>
                        <input type="range" id="startRange" min="1901" max="2018">
                    </p>

                    <p>End year:
                        <input class="year" type="text" id="end" pattern="^(19|20)\d{2}" value="">
                        <br><br>
                        <input type="range" id="endRange" min="1901" max="2018">
                    </p>
                </td>

                <td class="borderbox">
                    <select id="category">
                        <option value="">All categories</option>
                        <option value="medicine">Medicine</option>
                        <option value="literature">Literature</option>
                        <option value="peace">Peace</option>
                        <option value="physics">Physics</option>
                        <option value="chemistry">Chemistry</option>
                        <option value="economics">Economics</option>
                    </select>
                </td>

                <td class="borderbox">
                    <p>Country of birth:
                        <input type=text id="country"></p>
                </td>

                <td class="borderbox gendercol">
                    <p>
                        <input type="radio" name="gender" value="male" id="gendermale"> Male
                        <input type="radio" name="gender" value="female" id="genderfemale"> Female
                        <input type="radio" name="gender" value="other" id="allgender"> All
                    </p>
                </td>
            </tr>

            <tr>
                <td class="borderbox">
                    <button id="submitBtn">Submit</button>
                </td>
            </tr>
        </table>
    </div>


    <!--div to display results-->
    <div class="answers">
        <p id="id04"></p>
    </div>

    <script>
        (function(globalObj) {
            'use strict'

            var laureateObj = {};
            var filterObj = {};
            var xmlhttp = new XMLHttpRequest();

            xmlhttp.open("GET", "nobelWinners.json", true);
            if (xmlhttp.readyState != 4)
                xmlhttp.send();
            if (document.readyState === "loading")
                document.addEventListener("DOMContentLoaded", init);
            else
                init();


            function init() {
                filterObj.start = 0;
                filterObj.end = 0;
                filterObj.category = "";
                filterObj.country = "";
                filterObj.gender = "";

                var start = document.getElementById("start");
                var startRange = document.getElementById("startRange");
                // here using an arrow function
                start.addEventListener("change", () => {
                    if (validateYear(start))
                        startRange.value = start.value;
                }, false);
                startRange.addEventListener("change", function() {
                    start.value = startRange.value;
                }, false);

                var end = document.getElementById("end");
                var endRange = document.getElementById("endRange");
                end.addEventListener("change", function() {
                    if (validateYear(end))
                        endRange.value = end.value;
                }, false);
                endRange.addEventListener("change", function() {
                    end.value = endRange.value;
                }, false);

                var submit = document.getElementById("submitBtn");
                submit.addEventListener("click", function() {
                    if (checkUserInput(start, end)) {
                        doSubmit(start, end)
                    }
                }, false);
            }

            function getLaureate(laureateId) {
                var result = "";
                var laureateArr = laureateObj.laureates;
                for (var i = 0; i < laureateArr.length; i++) {
                    if (laureateArr[i].id == laureateId)
                        result = laureateArr[i];
                }
                return result;
            }

            function checkUserInput(start, end) {
                var message = document.getElementById("id04");
                var isValid = true;
                if (xmlhttp.readyState != 4 || xmlhttp.status != 200) {
                    message.innerHTML = "JSON File for laureates not loaded";
                    isValid = false;
                }
                if (!validateYear(start) || !validateYear(end)) {
                    message.innerHTML = "Invalid Start or End";
                    isValid = false;
                }
                if (parseInt(start.value) > parseInt(end.value)) {
                    message.innerHTML = "End year must be later than start year"
                    isValid = false
                }
                return isValid;
            }

            function doSubmit(start, end) {
                var display = document.getElementById("id04");
                if (!laureateObj.hasOwnProperty('laureates')) {
                    console.log("NOT Parsed");
                    laureateObj = JSON.parse(xmlhttp.responseText);
                }
                var category = document.getElementById("category").value;
                var country = document.getElementById("country").value;
                var gender = "";
                if (document.getElementById('gendermale').checked)
                    gender = "m";
                else {
                    if (document.getElementById('genderfemale').checked)
                        gender = "f";
                }
                if (start.value == "") {
                    start.value = 2018;
                    start.dispatchEvent(new Event('change'));
                }
                if (end.value == "") {
                    end.value = 2018;
                    end.dispatchEvent(new Event('change'));
                }
                if (isFilterChanged(start.value, end.value, category, country, gender)) {
                    filterObj.start = parseInt(start.value);
                    filterObj.end = parseInt(end.value);
                    filterObj.category = category;
                    filterObj.country = country;
                    filterObj.gender = gender;
                    var laureateArr =
                        filterLaureates(laureateObj.laureates, filterObj);
                    if (laureateArr.length == 0)
                        display.innerHTML = "No laureates match these criteria";
                    else {
                        var prizeArr = buildPrizeArray(laureateArr, filterObj);
                        var table = buildPrizeTable(prizeArr);
                        display.innerHTML = table;
                    }
                }
                toggleGenderCol();
            }

            function isFilterChanged(startYr, endYr, category, country, gender) {
                return startYr != filterObj.start || endYr != filterObj.end ||
                    category != filterObj.category || country != filterObj.country ||
                    gender != filterObj.gender;
            }

            // Bug in IE requires setting border
            function toggleGenderCol() {
                var e = document.getElementsByClassName("gendercol");
                for (var i = 0; i < e.length; i++) {
                    if (e[i].style.visibility != 'visible') {
                        e[i].style.visibility = 'visible';
                        e[i].style.border = "solid";
                    } else {
                        e[i].style.visibility = 'hidden';
                        e[i].style.border = "none";
                    }
                }
            };


            function validateYear(yearEl) {
                var isValid = true;
                if (yearEl.checkValidity() == false) {
                    document.getElementById("id04").innerHTML = "Invalid Year";
                    isValid = false;
                }
                return isValid;
            }

            function moreInformation(prizeId, prizeIndex) {
                var moreInfo = "";
                var laureate = getLaureate(prizeId);
                if (laureate != "") {
                    var prize = laureate.prizes[prizeIndex];
                    moreInfo = "<p class=\"moreinfo\">Year of birth: " + laureate.born;
                    if (laureate.hasOwnProperty('bornCity'))
                        moreInfo += "<br>City of birth: " + laureate.bornCity;
                    if (laureate.died != "0000-00-00")
                        moreInfo += "<br>Died in: " + laureate.died;
                    moreInfo += "<br>Motivation: " + prize.motivation;
                    for (var i = 0; i < prize.affiliations.length; i++) {
                        var nm = prize.affiliations[i].name == undefined ? "" : prize.affiliations[i].name;
                        var city = prize.affiliations[i].city == undefined ? "" : prize.affiliations[i].city;
                        if (nm != "" && city != "") {
                            moreInfo += "<br>Affiliation: " +
                                nm + ", " + city;
                        }
                    };
                    moreInfo += "</p>"
                    return moreInfo;
                }
            };

            function buildPrizeArray(laureateArr, filterObj) {
                var prizeArr = [];
                for (var i = 0; i < laureateArr.length; i++) {
                    for (var n = 0; n < laureateArr[i].prizes.length; n++) {
                        if (laureateArr[i].prizes[n].year >= filterObj.start &&
                            laureateArr[i].prizes[n].year <= filterObj.end &&
                            (filterObj.category == "" ||
                                filterObj.category == laureateArr[i].prizes[n].category)) {
                            var lPrize = {};
                            lPrize.laureate = laureateArr[i];
                            lPrize.prizeIndex = n;
                            lPrize.year = laureateArr[i].prizes[n].year;
                            lPrize.category = laureateArr[i].prizes[n].category;
                            prizeArr.push(lPrize);
                        }
                    }
                };
                return prizeArr.sort((a, b) => a.year - b.year);
            }

            function buildPrizeTable(prizeArr) {
                var table = "<table class=\"resultstable\" >" +
                    "<thead>" +
                    "<tr>" +
                    "<th>Year</th>" +
                    "<th class=\"resultname\">Name</th>" +
                    "<th>Category</th>" +
                    "<th>Gender</th>" +
                    "<th>Born in</th>" +
                    "<th></th>" +
                    "</tr>" +
                    "</thead>" +
                    "<tbody>"
                for (var i = 0; i < prizeArr.length; i++) {
                    var row = ("<tr><td>" + prizeArr[i].year +
                        "</td><td class=\"resultname\">" + prizeArr[i].laureate.firstname + " " +
                        prizeArr[i].laureate.surname +
                        "</td><td>" + prizeArr[i].category +
                        "</td><td>" + prizeArr[i].laureate.gender +
                        "</td><td>" + prizeArr[i].laureate.bornCountry +
                        "</td><td class=\"more\">" +
                        "<details>" +
                        "<summary>More... </summary>" +
                        moreInformation(prizeArr[i].laureate.id, prizeArr[i].prizeIndex) +
                        "</details>" +
                        "</tr>");
                    table += row;
                };
                table += "</tbody></table>";
                return table;
            };

            function filterLaureates(laureateArr, filterObj) {
                laureateArr = laureateArr.filter((laureate) => {
                    return filterYear(laureate, filterObj);
                });
                if (filterObj.category != "")
                    laureateArr = laureateArr.filter((laureate) => {
                        return filterCategory(laureate, filterObj);
                    });
                if (filterObj.country != "")
                    laureateArr = laureateArr.filter((laureate) => {
                        var regex = new RegExp(filterObj.country, 'gi');
                        return laureate.hasOwnProperty('bornCountry') &&
                            laureate.bornCountry.match(regex) != null;
                    });
                if (filterObj.gender != "") {
                    laureateArr = laureateArr.filter(function(laureate) {
                        return (filterObj.gender == "m" && laureate.gender == "male") ||
                            (filterObj.gender == "f" && laureate.gender == "female")
                    });
                }
                return laureateArr;
            };

            function filterYear(laureate, filterObj) {
                var accept = false;
                for (var n = 0; n < laureate.prizes.length; n++) {
                    var y = laureate.prizes[n].year;
                    if (y >= filterObj.start && y <= filterObj.end)
                        accept = true;
                }
                return accept;
            };

            function filterCategory(laureate, filterObj) {
                var accept = false;
                for (var n = 0; n < laureate.prizes.length; n++) {
                    if (laureate.prizes[n].category == filterObj.category)
                        accept = true;
                }
                return accept;
            };
        }(this))
    </script>

</body>

</html>